#!/bin/bash
#
# initrd_create:  make initrd rootdisk
#
# Author:	  Tomas Matejicek <http://www.linux-live.org>

. ../config || exit 1
. ./liblinuxlive || exit 1 

KERNEL=`/bin/uname -r`

echo "creating empty image file initrd.img..."
dd if=/dev/zero of=$INITRDIMG bs=1024 count=$RAM0SIZE >/dev/null 2>/dev/null

echo "making filesystem..."
mkfs -t ext2 -F -m 0 -i 1024 $INITRDIMG >/dev/null 2>/dev/null

echo "creating empty directory $MOUNTDIR..."
rm -Rf $MOUNTDIR
mkdir $MOUNTDIR

echo "mounting initrd.img to it..."
mount -o loop $INITRDIMG $MOUNTDIR

echo "creating directories..."
rmdir $MOUNTDIR/lost+found
mkdir -p $MOUNTDIR/{etc,dev,bin,mnt,proc,sbin,lib,tmp,usr/bin,usr/sbin}

echo "copying files to the rootdisk..."
touch $MOUNTDIR/etc/{m,fs}tab

# find all lib dependences
for BINARY in cp chmod touch tar gzip gunzip rm bash sh mount umount \
              mkdir rmdir ls ln echo cat grep egrep fdisk blockdev \
	      pivot_root insmod lsmod modprobe swapon eject tail tr \
	      chroot readlink basename dirname test sleep [ ;
do
   for LOCATION in /bin /sbin /usr/bin /usr/sbin ;
   do
      if [ -r "$LOCATION/$BINARY" ]; then
         rcopy "$LOCATION/$BINARY" "$MOUNTDIR"

         list_libs "$LOCATION/$BINARY" | sort | uniq | while read LIB; do
            if [ ! -a "$MOUNTDIR/$LIB" ]; then
               rcopy "$LIB" "$MOUNTDIR"
	    fi
	 done
      fi
   done
done
cp -R /sbin/*.old $MOUNTDIR/sbin # this line can be safely removed when using 2.6 kernel

#filesize script by using ls + cut
echo -ne "#!/bin/bash\necho \`ls -ol \"\$1\"\` | cut -d \" \" -f 4" >$MOUNTDIR/bin/filesize
chmod 0755 $MOUNTDIR/bin/filesize

LMK="lib/modules/$KERNEL"

#necessary modules and dependency files
mkdir -p $MOUNTDIR/$LMK
cp -R /$LMK/modules* $MOUNTDIR/$LMK
mkdir -p $MOUNTDIR/$LMK/kernel/fs/ovlfs
cp -R /$LMK/kernel/fs/ovlfs $MOUNTDIR/$LMK/kernel/fs

#disk (ide, scsi) modules
mkdir -p $MOUNTDIR/$LMK/kernel/drivers/ide
cp -R /$LMK/kernel/drivers/ide $MOUNTDIR/$LMK/kernel/drivers
mkdir -p $MOUNTDIR/$LMK/kernel/drivers/scsi
cp -R /$LMK/kernel/drivers/scsi $MOUNTDIR/$LMK/kernel/drivers

#copy filesystem modules, if not directly copied into kernel
mkdir -p $MOUNTDIR/$LMK/kernel/fs/ntfs
cp -R /$LMK/kernel/fs/ntfs $MOUNTDIR/$LMK/kernel/fs 2>/dev/null
mkdir -p $MOUNTDIR/$LMK/kernel/fs/ext3
cp -R /$LMK/kernel/fs/ext3 $MOUNTDIR/$LMK/kernel/fs 2>/dev/null
mkdir -p $MOUNTDIR/$LMK/kernel/fs/reiserfs
cp -R /$LMK/kernel/fs/reiserfs $MOUNTDIR/$LMK/kernel/fs 2>/dev/null

#usb modules
mkdir -p $MOUNTDIR/$LMK/kernel/drivers/usb
cp -R /$LMK/kernel/drivers/usb/usbcore* $MOUNTDIR/$LMK/kernel/drivers/usb 2>/dev/null
cp -R /$LMK/kernel/drivers/usb/host $MOUNTDIR/$LMK/kernel/drivers/usb 2>/dev/null
cp -R /$LMK/kernel/drivers/usb/storage $MOUNTDIR/$LMK/kernel/drivers/usb 2>/dev/null

cp {linuxrc,liblinuxlive} $MOUNTDIR # symlink will be copied as original file
chmod a+x $MOUNTDIR/linuxrc

echo "unmounting $MOUNTDIR and gzipping initrd.img..."
umount $MOUNTDIR
gzip --best $INITRDIMG

echo "deleting directory $MOUNTDIR..."
rm -Rf $MOUNTDIR
